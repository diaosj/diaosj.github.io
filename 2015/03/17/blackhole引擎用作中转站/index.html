<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>blackhole引擎用作中转站 | 山中日月长，云下饭藿香</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">blackhole引擎用作中转站</h1><a id="logo" href="/.">山中日月长，云下饭藿香</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">blackhole引擎用作中转站</h1><div class="post-meta">Mar 17, 2015</div><div class="post-content"><p>#引擎<br>BLACKHOLE存储引擎是将进来的数据全都扔掉，所有的查询永远返回一个空集，但该记的log还是全都记的。相当于只打卡不做事。创建一个BLACKHOLE的表时，MySQL server在数据库目录下创建一个对应的.frm格式文件，除此之外没有对应的文件了。<br><a id="more"></a></p>
<p>#场景<br>假设已有一个Master，一个Slave，配好了源源不断的同步。（嗯，我成语用得真是活灵活现。）现在有一个Remote，我希望将repl_table_201501..repl_table_201512这些月表都同步到Remote机器上。</p>
<p>出于容灾的考虑，Master和Slave上面binlog都是完备的。考虑到以下两点原因，直接加同步是不成立的：首先，Master是在生产环境下，最好不要在战斗的时候动手术；其次，binlog的量太大，全往网络上塞的行为太不环保。</p>
<p>这时，我们可以在Slave的机器上加一个名为Blackhole的实例，作为Slave的”Slave”与Remote的”Master”，实现一道滤网的作用。该实例中只有需要同步的表，且存储引擎都设为BLACKHOLE。这样，相当于只将需要的那部分binlog移到Remote上。</p>
<p>#步骤</p>
<p>##新实例<br>知道的启动MySQL实例的方式大致有3种：</p>
<ul>
<li>使用service：service mysqld start</li>
<li>使用mysqld：/etc/init.d/mysqld start</li>
<li>使用mysqld_safe：mysqld_safe &amp;</li>
</ul>
<p>另外mysql_multi的套路待研究。因为不希望影响到之前的实例，这里使用最简单的第三种。</p>
<p>先看一下现在服务器上有哪些实例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux | grep mysql</div></pre></td></tr></table></figure>
<p>然后新建个blackhole目录。初始化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/mysql/scripts/mysql_install_db --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/path/to/blackhole --user=mysql</div></pre></td></tr></table></figure>
<p>新建my.cnf文件，修改以下几个参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">datadir = /path/to/blackhole</div><div class="line">port = 3309</div><div class="line">server-id = 4</div></pre></td></tr></table></figure>
<p>其它的，看情况便宜行事。</p>
<p>启动blackhole实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqld_safe --defaults-file=/path/to/blackhole/my.cnf --pid-file=/path/to/blackhole/mysql.pid &amp;</div></pre></td></tr></table></figure>
<p>验证一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux | grep 3309</div></pre></td></tr></table></figure>
<p>要连的话：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -h127.0.0.1 -P3309</div></pre></td></tr></table></figure>
<p>注意，这里有个坑。-h参数不指明是127.0.0.1时可能默认用socket连接，也许你连上的不是你所想的实例。你以为你以为的就是你以为的？</p>
<p>##同步配置<br>分别修改Slave、Blackhole、Remote的my.cnf文件。<br>以Blackhole为例，作为Remote的”Master”：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">log-slave-updates   = 1</div><div class="line">log-bin             = mysql-bin</div><div class="line">log-bin_index       = mysql-bin.index</div><div class="line">binlog_format       = mixed</div><div class="line">binlog_cache_size   = 1M</div><div class="line">expire_logs_days    = 3</div><div class="line">log-bin-trust-function-creators</div><div class="line"></div><div class="line">binlog_ignore_db = information_schema</div><div class="line">binlog_ignore_db = mysql</div><div class="line">binlog_ignore_db = performance_schema</div><div class="line">binlog_ignore_db = test</div></pre></td></tr></table></figure>
<p>log-bin选项给出了二进制日志产生的所有文件的基本名。</p>
<p>log-bin-index选项给出了二进制索引文件的文件名，这个索引文件保存了所有binlog文件的列表。</p>
<p>作为Slave的”Slave”：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">relay-log-index = mysql-relay-bin_index</div><div class="line">relay-log       = mysql-relay-bin</div><div class="line"></div><div class="line">replicate-wild-do-table = database.repl_table_20%</div><div class="line">replicate-do-table = database.repl_table</div></pre></td></tr></table></figure>
<p>另外两边的my.cnf文件类似配置一下。</p>
<p>Slave上要给Blackhole开一个复制的账号，Blackhole上也要给Remote开一个同步的账号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CREATE USER repl_user;</div><div class="line">GRANT REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO repl_user@&apos;ip&apos; IDENTIFIED BY &apos;password&apos;;</div></pre></td></tr></table></figure>
<p>##数据<br>要使前面修改的配置生效必须重启各个实例。重启之前，我们要注意到，现在Master和Slave上的同步还在跑着，为了保证数据一致，我们修改Slave的my.cnf文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">skip-networking</div></pre></td></tr></table></figure>
<p>然后重启各个实例。这时Slave是处于“静止”的状态，没有数据插入。</p>
<p>将要同步的repl_table_201501..repl_table_201512这些月表dump出来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysqldump -p <span class="_">-d</span> database --table repl_table &gt; table_struct.sql</div><div class="line">mysqldump -p -t database repl_table &gt; table_data.sql</div></pre></td></tr></table></figure>
<p>确定binlog位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SHOW SLAVE STATUS\G</div></pre></td></tr></table></figure>
<p>然后注释掉my.cnf中的skip-networking。重启，Slave正常运行。</p>
<p>Blackhole上建表，注意存储引擎都是BLACKHOLE。然后CHANGE MASTER TO之前记录的binlog位置。</p>
<p>Remote上导入数据。CHANGE MASTER TO Blackhole上。</p>
<p>这样就完成了。注意测试。</p>
<p>#后续<br>如果有别的表需要追加同步，遵循以下步骤即可：</p>
<ul>
<li>停掉Slave：stop slave</li>
<li>导出Slave上的表结构和数据</li>
<li>修改Blackhole的my.cnf，增加同步，重启</li>
<li>表结构改为BLACKHOLE，导入Blackhole</li>
<li>表结构导入Remote</li>
<li>表数据导入BLACKHOLE</li>
<li>开启Slave：start slave</li>
</ul>
</div><div class="tags"><a href="/tags/MySQL/">MySQL</a></div><div class="post-nav"><a class="pre" href="/2015/03/20/配置同步踩到的坑/">配置同步踩到的坑</a><a class="next" href="/2015/03/15/你的名字是爱情/">你的名字是爱情</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://diaosj.info"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Tornado/" style="font-size: 15px;">Tornado</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Infobright/" style="font-size: 15px;">Infobright</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/CodeIgniter/" style="font-size: 15px;">CodeIgniter</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/足球/" style="font-size: 15px;">足球</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Lua/" style="font-size: 15px;">Lua</a> <a href="/tags/乱翻书/" style="font-size: 15px;">乱翻书</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Yaf/" style="font-size: 15px;">Yaf</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/Yii/" style="font-size: 15px;">Yii</a> <a href="/tags/Zend/" style="font-size: 15px;">Zend</a> <a href="/tags/Perl/" style="font-size: 15px;">Perl</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/Gevent/" style="font-size: 15px;">Gevent</a> <a href="/tags/Web-py/" style="font-size: 15px;">Web.py</a> <a href="/tags/Bottle/" style="font-size: 15px;">Bottle</a> <a href="/tags/Celery/" style="font-size: 15px;">Celery</a> <a href="/tags/Twisted/" style="font-size: 15px;">Twisted</a> <a href="/tags/NumPy/" style="font-size: 15px;">NumPy</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/English/" style="font-size: 15px;">English</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/TokuDB/" style="font-size: 15px;">TokuDB</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/单车/" style="font-size: 15px;">单车</a> <a href="/tags/AWS/" style="font-size: 15px;">AWS</a> <a href="/tags/FastDFS/" style="font-size: 15px;">FastDFS</a> <a href="/tags/围棋/" style="font-size: 15px;">围棋</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/Recommendation/" style="font-size: 15px;">Recommendation</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/数学/" style="font-size: 15px;">数学</a> <a href="/tags/游戏/" style="font-size: 15px;">游戏</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/30/Simplification-One-Way-to-Make-Us-Smarter/">Simplification: One Way to Make Us Smarter</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/The-Cultural-Dimension-of-Globalization/">The Cultural Dimension of Globalization</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/17/看球笔记-4/">看球笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/年会/">年会</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/22/RAID卡相关信息查询/">RAID卡相关信息查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/21/ft-index源码阅读/">ft-index源码阅读</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/20/Nginx源码阅读/">Nginx源码阅读</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/18/jQuery源码阅读/">jQuery源码阅读</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/14/推荐系统各家实战笔记/">推荐系统各家实战笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/生日问题/">生日问题</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">山中日月长，云下饭藿香.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>